<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BITEY PROTRACKER</title>
  <style>
    :root {
      --bg: #9b9b9b;
      --panel: #a8a8a8;
      --panel-hi: #c7c7c7;
      --panel-lo: #6f6f6f;
      --screen: #040404;
      --ink: #0c0c0c;
      --green: #14d114;
      --green-dim: #0b7f0b;
      --amber: #e0c83f;
      --danger: #b02323;
      --font: "Courier New", "Lucida Console", monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      background: #7d7d7d;
      color: var(--ink);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 12px;
    }
    .tracker {
      width: min(980px, 100%);
      border: 2px solid #dedede;
      box-shadow:
        inset 1px 1px 0 #ffffff,
        inset -1px -1px 0 #5f5f5f,
        0 8px 18px rgba(0,0,0,.25);
      background: var(--bg);
      overflow: hidden;
    }
    .titlebar {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-bottom: 2px solid #8e8e8e;
      background: linear-gradient(#b7b7b7, #9d9d9d);
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 20px;
    }
    .brand { text-transform: uppercase; }
    .clock {
      font-size: 18px;
      background: #a1a1a1;
      padding: 2px 8px;
      border: 2px solid;
      border-color: #d8d8d8 #6b6b6b #6b6b6b #d8d8d8;
      min-width: 110px;
      text-align: center;
    }
    .topgrid {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 6px;
      padding: 6px;
      border-bottom: 2px solid #888;
    }
    .leftctl, .rightctl {
      background: var(--panel);
      border: 2px solid;
      border-color: var(--panel-hi) var(--panel-lo) var(--panel-lo) var(--panel-hi);
      padding: 6px;
      min-height: 250px;
    }
    .ctl-row {
      display: grid;
      grid-template-columns: 1fr 90px;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 28px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .ctl-row small { font-size: 20px; }
    .value-box {
      background: #9f9f9f;
      border: 2px solid;
      border-color: #dadada #6a6a6a #6a6a6a #dadada;
      text-align: right;
      padding: 1px 6px;
      letter-spacing: 1px;
    }
    .file-wrap {
      margin-top: 8px;
      border-top: 2px solid #898989;
      padding-top: 8px;
      font-size: 20px;
      font-weight: 700;
    }
    .file-wrap input[type="file"] {
      width: 100%;
      margin-top: 6px;
      font: inherit;
      font-size: 18px;
    }
    .master-row {
      margin-top: 8px;
      display: grid;
      grid-template-columns: 1fr 90px;
      gap: 6px;
      align-items: center;
      font-size: 24px;
      font-weight: 700;
      text-transform: uppercase;
    }
    #master-gain {
      width: 100%;
      font: inherit;
      font-size: 24px;
      padding: 2px 4px;
      border: 2px solid;
      border-color: #dadada #6a6a6a #6a6a6a #dadada;
      background: #b6b6b6;
    }
    .btnrow {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-top: 10px;
    }
    button, .btn {
      font: inherit;
      font-size: 22px;
      font-weight: 700;
      text-transform: uppercase;
      border: 2px solid;
      border-color: #dfdfdf #5f5f5f #5f5f5f #dfdfdf;
      background: #a8a8a8;
      color: #111;
      padding: 5px 6px;
      text-decoration: none;
      text-align: center;
      cursor: pointer;
    }
    button:active, .btn:active {
      border-color: #5f5f5f #dfdfdf #dfdfdf #5f5f5f;
    }
    .primary { background: #a4c7a4; }
    .warn { background: #c8b88a; }
    .status {
      margin-top: 8px;
      min-height: 28px;
      font-size: 24px;
      font-weight: 700;
      color: #111;
    }
    .status.error { color: var(--danger); }
    .status.ok { color: #105f10; }

    .scope-line {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
    }
    .scope {
      height: 96px;
      background: var(--screen);
      border: 2px solid;
      border-color: #5e5e5e #d0d0d0 #d0d0d0 #5e5e5e;
      position: relative;
      overflow: hidden;
    }
    .scope::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(transparent 49%, rgba(16,209,16,.12) 50%, transparent 51%),
        linear-gradient(90deg, transparent 49%, rgba(16,209,16,.08) 50%, transparent 51%);
      background-size: 100% 18px, 28px 100%;
    }
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    .meta {
      background: #9f9f9f;
      border: 2px solid;
      border-color: #dadada #6a6a6a #6a6a6a #dadada;
      padding: 4px;
      font-size: 18px;
      font-weight: 700;
      min-height: 62px;
    }
    .meta b { display: block; text-transform: uppercase; font-size: 16px; }

    .tracker-grid-wrap {
      border-top: 2px solid #868686;
      padding: 6px;
      background: #9b9b9b;
    }
    .channels {
      display: grid;
      grid-template-columns: repeat(8, minmax(90px, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }
    .ch {
      border: 2px solid;
      border-color: #dadada #666 #666 #dadada;
      background: #9f9f9f;
      padding: 4px;
      display: grid;
      gap: 4px;
      justify-items: center;
    }
    .name {
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      width: 100%;
      text-align: center;
      border-bottom: 2px solid #858585;
      padding-bottom: 2px;
    }
    .vu {
      width: 100%;
      height: 92px;
      border: 2px solid #7a7a7a;
      background: #030303;
      position: relative;
      overflow: hidden;
    }
    .vu-fill {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 0%;
      background: linear-gradient(0deg, #0da50d 0%, #15ea15 70%, #d7ce2f 100%);
    }
    .db { font-size: 16px; font-weight: 700; text-transform: uppercase; }
    input[type="range"].fader {
      width: 100%;
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      appearance: slider-vertical;
      height: 112px;
      background: transparent;
    }
    .value { font-size: 18px; font-weight: 700; }

    .pattern {
      background: #040404;
      border: 2px solid;
      border-color: #666 #ddd #ddd #666;
      color: var(--green);
      min-height: 190px;
      font-size: 28px;
      line-height: 1.1;
      padding: 6px;
      overflow: hidden;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .pattern .line {
      display: grid;
      grid-template-columns: 46px repeat(8, 1fr);
      gap: 6px;
      margin-bottom: 2px;
    }
    .pattern .idx { color: #14a114; }
    .pattern .col { color: #14d114; }
    .pattern .col.active { color: var(--amber); }

    .note {
      padding: 0 6px 6px;
      font-size: 16px;
      text-transform: uppercase;
      font-weight: 700;
    }

    @media (max-width: 980px) {
      .titlebar { font-size: 16px; }
      .topgrid { grid-template-columns: 1fr; }
      .meta-grid { grid-template-columns: repeat(2, 1fr); }
      .channels { grid-template-columns: repeat(4, minmax(90px, 1fr)); }
      .pattern { font-size: 20px; }
    }
    @media (max-width: 640px) {
      .channels { grid-template-columns: repeat(2, minmax(90px, 1fr)); }
      .btnrow { grid-template-columns: 1fr; }
      .ctl-row { font-size: 22px; }
    }
  </style>
</head>
<body>
  <main class="tracker">
    <section class="titlebar">
      <div class="brand">BITEY PROTRACKER</div>
      <div class="clock" id="time-readout">00:00 / 00:00</div>
    </section>

    <section class="topgrid">
      <div class="leftctl">
        <div class="ctl-row"><small>Position</small><span class="value-box" id="meta-pos">00</span></div>
        <div class="ctl-row"><small>Pattern</small><span class="value-box">01</span></div>
        <div class="ctl-row"><small>Length</small><span class="value-box" id="meta-duration">---</span></div>
        <div class="ctl-row"><small>Restart</small><span class="value-box">00</span></div>

        <div class="file-wrap">
          SOURCE WAV FILE
          <input id="source-wav" type="file" accept=".wav,audio/wav">
        </div>

        <div class="master-row">
          <span>Master</span>
          <input id="master-gain" type="number" min="0" max="2" step="0.05" value="1.00">
        </div>

        <div class="btnrow">
          <button id="build" class="primary" type="button">Build Session</button>
          <button id="download" class="warn" type="button" disabled>Export ZIP</button>
          <a class="btn" href="/" target="_blank" rel="noopener">Home</a>
        </div>

        <div id="status" class="status">Ready.</div>
      </div>

      <div class="rightctl">
        <div class="scope-line">
          <div class="scope"></div>
          <div class="scope"></div>
        </div>
        <div class="meta-grid">
          <div class="meta"><b>Source</b><span id="meta-source">-</span></div>
          <div class="meta"><b>Avg BPM</b><span id="meta-bpm">-</span></div>
          <div class="meta"><b>Key</b><span id="meta-key">-</span></div>
          <div class="meta"><b>Job</b><span id="meta-job">IDLE</span></div>
        </div>
      </div>
    </section>

    <section class="tracker-grid-wrap">
      <div class="channels" id="channels"></div>

      <div class="pattern" id="pattern-view">
        <div class="line"><span class="idx">00</span><span class="col active">C-3 10 00</span><span class="col">---</span><span class="col">G-2 20 00</span><span class="col">---</span><span class="col">C-4 10 00</span><span class="col">---</span><span class="col">G-3 20 00</span><span class="col">---</span></div>
        <div class="line"><span class="idx">01</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span></div>
        <div class="line"><span class="idx">02</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span></div>
        <div class="line"><span class="idx">03</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span></div>
        <div class="line"><span class="idx">04</span><span class="col active">C-3 10 00</span><span class="col">---</span><span class="col">G-2 20 00</span><span class="col">---</span><span class="col">C-4 10 00</span><span class="col">---</span><span class="col">G-3 20 00</span><span class="col">---</span></div>
        <div class="line"><span class="idx">05</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span></div>
        <div class="line"><span class="idx">06</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span></div>
        <div class="line"><span class="idx">07</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span><span class="col">---</span></div>
      </div>
    </section>

    <div class="note">
      BITEY PROTRACKER: WAV INPUT, SOURCE-DRIVEN LOFI RENDER, STEM MIXER + TRACKER VIEW.
    </div>
  </main>

  <script>
    const TRACKS = ["kick", "snare", "hat", "bass", "arp", "chord", "lead", "fx"];
    const state = {
      sessionId: null,
      context: null,
      masterGain: null,
      buffers: new Map(),
      gainNodes: new Map(),
      analyserNodes: new Map(),
      sources: [],
      startedAt: 0,
      offset: 0,
      isPlaying: false,
      duration: 0,
      raf: 0,
      jobId: "",
    };

    const el = {
      sourceWav: document.getElementById("source-wav"),
      masterGain: document.getElementById("master-gain"),
      build: document.getElementById("build"),
      download: document.getElementById("download"),
      status: document.getElementById("status"),
      timeReadout: document.getElementById("time-readout"),
      channels: document.getElementById("channels"),
      metaSource: document.getElementById("meta-source"),
      metaBpm: document.getElementById("meta-bpm"),
      metaDuration: document.getElementById("meta-duration"),
      metaKey: document.getElementById("meta-key"),
      metaPos: document.getElementById("meta-pos"),
      metaJob: document.getElementById("meta-job"),
    };

    const vuElements = new Map();

    function setStatus(message, mode = "") {
      el.status.textContent = message;
      el.status.classList.toggle("error", mode === "error");
      el.status.classList.toggle("ok", mode === "ok");
    }

    function fmtTime(seconds) {
      const s = Math.max(0, Math.floor(seconds || 0));
      const m = Math.floor(s / 60);
      const rem = s % 60;
      return `${String(m).padStart(2, "0")}:${String(rem).padStart(2, "0")}`;
    }

    async function looksLikeWav(file) {
      const buf = await file.slice(0, 12).arrayBuffer();
      const sig = new Uint8Array(buf);
      const ascii = (arr) => String.fromCharCode(...arr);
      if (sig.length < 12) return false;
      return ascii(sig.slice(0, 4)) === "RIFF" && ascii(sig.slice(8, 12)) === "WAVE";
    }

    function currentTimePosition() {
      if (!state.isPlaying || !state.context) return state.offset;
      return Math.min(state.duration, state.offset + (state.context.currentTime - state.startedAt));
    }

    function updateTimeReadout() {
      const pos = currentTimePosition();
      el.timeReadout.textContent = `${fmtTime(pos)} / ${fmtTime(state.duration)}`;
      const row = Math.min(63, Math.floor(pos * 4) % 64);
      el.metaPos.textContent = String(row).padStart(2, "0");
    }

    function buildChannelUi() {
      el.channels.innerHTML = "";
      TRACKS.forEach((track) => {
        const box = document.createElement("div");
        box.className = "ch";
        box.innerHTML = `
          <div class="name">${track}</div>
          <div class="vu"><div class="vu-fill" data-track="${track}"></div></div>
          <div class="db" data-db="${track}">-INF DB</div>
          <input class="fader" data-fader="${track}" type="range" min="0" max="1.4" step="0.01" value="1.00">
          <div class="value" data-value="${track}">1.00</div>
        `;
        el.channels.appendChild(box);

        const fader = box.querySelector(`[data-fader="${track}"]`);
        const valueEl = box.querySelector(`[data-value="${track}"]`);
        const vuFill = box.querySelector(`[data-track="${track}"]`);
        const dbEl = box.querySelector(`[data-db="${track}"]`);
        vuElements.set(track, { vuFill, dbEl });

        fader.addEventListener("input", () => {
          const val = Number.parseFloat(fader.value);
          valueEl.textContent = val.toFixed(2);
          const gain = state.gainNodes.get(track);
          if (gain) gain.gain.value = val;
        });
      });
    }

    async function ensureAudioContext() {
      if (state.context) return state.context;
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      state.context = new AudioCtx();
      state.masterGain = state.context.createGain();
      state.masterGain.gain.value = Number.parseFloat(el.masterGain.value || "1") || 1;
      state.masterGain.connect(state.context.destination);
      return state.context;
    }

    function stopPlayback(resetOffset = false) {
      state.sources.forEach((src) => {
        try { src.stop(); } catch (_) {}
      });
      state.sources = [];
      state.isPlaying = false;
      if (resetOffset) state.offset = 0;
      if (state.raf) cancelAnimationFrame(state.raf);
      updateTimeReadout();
    }

    function renderMeters() {
      if (!state.isPlaying) return;
      TRACKS.forEach((track) => {
        const analyser = state.analyserNodes.get(track);
        const ui = vuElements.get(track);
        if (!analyser || !ui) return;

        const arr = new Uint8Array(analyser.fftSize);
        analyser.getByteTimeDomainData(arr);

        let peak = 0;
        for (let i = 0; i < arr.length; i += 1) {
          const v = (arr[i] - 128) / 128;
          const a = Math.abs(v);
          if (a > peak) peak = a;
        }

        const normalized = Math.min(1, peak * 1.8);
        ui.vuFill.style.height = `${Math.round(normalized * 100)}%`;
        const db = peak > 0.00001 ? (20 * Math.log10(peak)).toFixed(1) : "-inf";
        ui.dbEl.textContent = `${db.toUpperCase()} DB`;
      });

      updateTimeReadout();
      if (currentTimePosition() >= state.duration) {
        stopPlayback(true);
        return;
      }
      state.raf = requestAnimationFrame(renderMeters);
    }

    async function decodeStem(url) {
      const res = await fetch(url);
      if (!res.ok) {
        let detail = "";
        try { detail = await res.text(); } catch (_) {}
        throw new Error(`Failed to load stem (${res.status}) ${url}${detail ? `: ${detail}` : ""}`);
      }
      const buf = await res.arrayBuffer();
      return state.context.decodeAudioData(buf.slice(0));
    }

    async function loadSessionStems(stemUrls) {
      state.buffers.clear();
      state.gainNodes.clear();
      state.analyserNodes.clear();

      for (const track of TRACKS) {
        const gain = state.context.createGain();
        gain.gain.value = 1;
        const analyser = state.context.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.74;

        gain.connect(analyser);
        analyser.connect(state.masterGain);

        state.gainNodes.set(track, gain);
        state.analyserNodes.set(track, analyser);
      }

      await Promise.all(TRACKS.map(async (track) => {
        const buffer = await decodeStem(stemUrls[track]);
        state.buffers.set(track, buffer);
      }));

      state.duration = state.buffers.get(TRACKS[0])?.duration || 0;
      state.offset = 0;
      updateTimeReadout();
    }

    async function waitForJob(jobId) {
      const maxPolls = 720;
      for (let i = 0; i < maxPolls; i += 1) {
        const res = await fetch(`/api/atari/job/${jobId}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || `Build job failed (${res.status})`);
        }
        if (data.status === "ready") {
          return data;
        }
        if (data.status === "failed") {
          throw new Error(data.error || "Build failed");
        }
        el.metaJob.textContent = `${data.status || "RUN"}`.toUpperCase();
        setStatus(`Building session... ${Math.min(99, Math.floor((i / maxPolls) * 100))}%`);
        await new Promise((r) => setTimeout(r, 1000));
      }
      throw new Error("Build timed out. Try a shorter PCM WAV file.");
    }

    async function startPlayback() {
      if (state.isPlaying || !state.context) return;
      const offset = Math.min(state.offset, Math.max(0, state.duration - 0.05));
      state.sources = [];

      TRACKS.forEach((track) => {
        const buffer = state.buffers.get(track);
        const gain = state.gainNodes.get(track);
        if (!buffer || !gain) return;
        const src = state.context.createBufferSource();
        src.buffer = buffer;
        src.connect(gain);
        src.start(0, offset);
        state.sources.push(src);
      });

      state.startedAt = state.context.currentTime;
      state.isPlaying = true;
      renderMeters();
    }

    function pausePlayback() {
      if (!state.isPlaying || !state.context) return;
      state.offset = currentTimePosition();
      stopPlayback(false);
    }

    async function buildSession() {
      const file = el.sourceWav.files?.[0];
      if (!file) {
        setStatus("Choose a WAV file first.", "error");
        return;
      }
      if (!file.name.toLowerCase().endsWith(".wav")) {
        setStatus("Only WAV files are supported.", "error");
        return;
      }
      if (!(await looksLikeWav(file))) {
        setStatus("This file is not a true WAV (RIFF/WAVE). Convert to PCM WAV first.", "error");
        return;
      }

      el.build.disabled = true;
      el.download.disabled = true;
      setStatus("Starting build...");

      try {
        await ensureAudioContext();
        pausePlayback();

        const form = new FormData();
        form.append("source_wav", file, file.name);

        const res = await fetch("/api/atari/session", { method: "POST", body: form });
        let data = {};
        try { data = await res.json(); } catch (_) {}
        if (!res.ok && res.status !== 202) throw new Error(data.error || "Session build failed");
        if (!data.job_id) throw new Error("Build job was not created");

        state.jobId = data.job_id;
        el.metaJob.textContent = `JOB ${state.jobId.slice(0, 6).toUpperCase()}`;

        data = await waitForJob(data.job_id);
        state.sessionId = data.session_id;
        await loadSessionStems(data.stem_urls);

        el.metaSource.textContent = data.source_name || "source.wav";
        el.metaBpm.textContent = String(data.bpm);
        el.metaDuration.textContent = `${data.duration_seconds}s`;
        el.metaKey.textContent = data.estimated_key || "-";
        el.metaJob.textContent = "READY";

        el.download.disabled = false;
        setStatus(`Ready: ${data.bpm} BPM, ${data.estimated_key}.`, "ok");
        await startPlayback();
      } catch (err) {
        el.metaJob.textContent = "FAILED";
        setStatus(err.message || "Session build failed.", "error");
      } finally {
        el.build.disabled = false;
      }
    }

    async function downloadSessionZip() {
      if (!state.sessionId) {
        setStatus("Build a session first.", "error");
        return;
      }
      try {
        setStatus("Preparing ZIP export...");
        const res = await fetch(`/api/atari/session/${state.sessionId}/export`, { method: "POST" });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "Export failed");
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const cd = res.headers.get("Content-Disposition") || "";
        const m = cd.match(/filename="([^"]+)"/);
        a.href = url;
        a.download = m ? m[1] : "bitey-protracker-stems.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setStatus("ZIP export downloaded.", "ok");
      } catch (err) {
        setStatus(err.message || "Export failed.", "error");
      }
    }

    el.masterGain.addEventListener("input", () => {
      const val = Number.parseFloat(el.masterGain.value || "1") || 1;
      if (state.masterGain) state.masterGain.gain.value = val;
    });

    el.build.addEventListener("click", buildSession);
    el.download.addEventListener("click", downloadSessionZip);

    buildChannelUi();
    updateTimeReadout();
  </script>
</body>
</html>
